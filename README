# UserChat Daily Unique Users Counter

這是一個 Chrome/Edge (Manifest V3) 擴充功能。當你開啟 MIS Bot 平台的查詢頁面時，會在頁面右下角顯示統計面板，計算每日唯一使用人數（同一 user 在同一天內對同一 GPT 使用 1~N 次均只算 1）。

支援：
- 當頁快速統計
- 透過分頁導覽列抓取同條件的所有頁次，進行聚合
- 匯出 CSV
- **KPI 摘要功能** - 顯示週間關鍵績效指標

## 安裝與使用
1. 打開瀏覽器 chrome://extensions 或 edge://extensions。
2. 開啟「開發人員模式」。
3. 點「載入未封裝項目」，選擇本資料夾 `extension`。
4. 進入目標頁面（URL 以 `https://misbot-beta.mitac.com.tw/pms/platformAnalysis/UserChat` 開頭）。
5. 右下角面板會自動出現：
   - 「聚合全部頁」：透過分頁列把所有頁面的資料抓回來統計。
   - 「匯出 CSV」：將統計結果下載為 CSV。
   - 「KPI摘要」：切換至 KPI 摘要視圖。

## KPI 摘要功能

點擊「KPI摘要」按鈕可以查看以下關鍵績效指標：

| 指標 | 說明 |
|------|------|
| 週起/週終 | 當前週的起始和結束日期（週一至週五） |
| 日活平均 DAU (avg) | 本週平均每日活躍用戶數 |
| 週活 WAU | 本週活躍用戶總數（去重） |
| 本週查詢總數 | 本週所有用戶查詢次數總計 |
| 高峰時段 | 查詢量最高的小時時段 |
| 高峰時段查詢數 | 高峰時段的查詢總數 |
| 每用戶平均查詢 | 本週平均每位用戶的查詢次數 |
| 解決率 | 查詢問題的解決比例（基於內容分析） |
| 平均回答正確率 | 回答的平均準確度（基於內容分析） |
| 平均解決嘗試次數 | 解決問題的平均嘗試次數（基於解決數量） |
| 未解決數量 | 未能解決的查詢數量 |
| 本週新用戶 | 首次使用平台的新用戶數 |
| 本週回訪用戶 | 之前使用過平台的回訪用戶數 |

## 智能分析功能

### GPT回答品質自動評估
系統會自動分析**GPT的回答內容**來判斷問題解決狀況和回答品質：

#### 解決狀態判斷標準：
- **是**：GPT提供了完整、詳細且**切題**的解答（包含文件引用、具體步驟、範例或完整流程說明）
- **部分**：GPT提供了一般性回答，有一定幫助但可能不夠詳細或完整
- **否**：GPT明確表示無法提供相關資訊、建議聯繫其他部門、純粹的道歉回應，或**答非所問**
- **未知**：無GPT回應或回應內容無法判斷品質

#### 回答正確率評估標準：
- **95%**：完美回答（文件引用 + 結構化內容 + 詳細說明 + 有用關鍵詞 + **切題**）
- **90%**：優秀回答（結構化內容或列表 + 詳細說明 + 文件引用 + **切題**）
- **85%**：良好回答（有用關鍵詞 + 詳細說明 + 結構化內容或文件引用 + **切題**）
- **75%**：一般回答（結構化內容或範例或具體資訊 + 詳細說明）
- **70%**：基本回答（有用關鍵詞 + 詳細說明）
- **60%**：簡單回答（僅有詳細說明，長度>100字）
- **50%**：短回答（中等長度內容，50-100字）
- **40%**：答非所問（詳細但與問題無關的回答）
- **30%**：不足回答（無相關資訊、建議聯繫其他部門）
- **20%**：無效回答（純道歉或完全無法提供幫助，且無實質內容）

### GPT回答品質關鍵詞分析

#### 高品質回答指標：
- **文件引用詞彙**：根據公司、根據文件、作業程序、FAQ.docx、根據.*文件
- **結構性詞彙**：詳細步驟、具體方法、完整說明、處理方式如下、以下是
- **教學性詞彙**：範例、示例、教學、指導、建議、推薦、解決方案
- **邏輯性詞彙**：首先、其次、然後、最後、接下來、另外
- **結構化特徵**：編號列表(1.2.3.)、步驟分解、流程說明、項目符號(*•-)
- **具體資訊**：期限、有效期、發生日、個月、時間、折算、薪資、具體數字

#### 低品質回答指標：
- **無資訊表達**：沒有.*資訊、目前沒有、沒有相關、無法直接找到、並沒有被提及
- **推託性詞彙**：建議您直接聯繫、請聯繫、請諮詢、建議聯繫、進一步諮詢
- **道歉性詞彙**：抱歉、很抱歉、不好意思、無法、不能、不清楚、不確定
- **不確定性詞彙**：可能、或許、也許、暫時無法、資訊不足

### 問答配對機制
系統會自動配對用戶問題與對應的GPT回答，並進行主題相關性檢測：
1. **優先使用chatId配對**：相同chatId的User和Gpt記錄自動配對
2. **時間窗口配對**：對於無chatId的記錄，在1分鐘時間窗口內尋找對應回答
3. **用戶ID匹配**：確保問答來自同一用戶
4. **順序邏輯**：按時間順序處理，避免錯誤配對
5. **主題相關性檢測**：分析用戶問題關鍵詞（如特休、喪假、婚假等）與GPT回答內容的相關性，檢測答非所問的情況

## 統計規則
- 以 anchor `a.textChat-icon.icon` 上的 `data-userid`, `data-gptid`, `data-time` 為準。
- `data-time` 取日期部分 (YYYY-MM-DD) 作為分組 key。
- 每天以 Set 方式去重 userId，得到每日唯一人次。
- KPI 統計自動以當前週（週一至週五）為範圍進行計算。

## 可能差異
- 若頁面結構有改動（無 `data-*` 或不同的表格結構），腳本會退回以表格欄位猜測，但結果可能不完整；請回報以便調整選擇器。
- 解決率和回答正確率基於GPT回答內容的關鍵詞分析，可能與實際用戶滿意度有差異。
- 問答配對基於時間順序和用戶ID，如果對話記錄不完整可能影響配對準確性。
- GPT回答品質評估僅供參考，實際回答效果需要結合具體的用戶回饋數據。

## 權限說明
- 僅使用 content_scripts 注入需要的頁面，不需背景權限。
- `host_permissions` 僅包含目標網域，以便在分頁聚合時以 fetch 取回其他頁。
