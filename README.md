
![version](https://img.shields.io/badge/version-v0.3.0-blue) ![license](https://img.shields.io/badge/license-internal-important) ![performance](https://img.shields.io/badge/performance-optimized-success)

# 🧑‍💻 UserChat Daily Unique Users Counter

> ⚠️ **本工具僅供內部使用，請勿外流。**

---

## 📚 目錄
[TOC]
1. 🚀 [核心功能](#-核心功能)
2. 🛠️ [安裝與使用](#-安裝與使用)
3. 📊 [KPI 摘要功能](#-kpi-摘要功能)
4. 📋 [四大核心表格功能](#-四大核心表格功能)
5. 🧠 [AI 智能分析系統](#-ai-智能分析系統)
6. 📊 [統計規則與資料來源](#-統計規則與資料來源)
7. 🏗️ [系統架構與資料流程](#-系統架構與資料流程)
8. 📐 [KPI 精確計算公式](#-kpi-精確計算公式)
9. 📄 [CSV 匯出格式說明](#-csv-匯出格式說明)
10. 🔐 [權限、安全與隱私](#-權限與安全性說明)
11. 🛠️ [開發與偵錯指南](#-開發與偵錯指南)
12. ❓ [常見問題與故障排除](#-常見問題與故障排除)
13. 🗺️ [Roadmap](#-roadmap)
14. ❓ [FAQ（進階）](#-faq進階)
15. 📝 [版本資訊](#版本資訊)

---


## 🚀 核心功能

### 📊 統計分析
- **每日唯一使用人數統計**：同一用戶在同一天內的多次使用僅計算一次
- **跨頁面數據聚合**：透過分頁導覽列抓取所有頁面數據進行統計
- **24小時使用時段分佈**：分析用戶使用習慣與高峰時段
- **週間 KPI 摘要**：自動計算週一至週五的關鍵績效指標

### 🧠 AI 品質評估
- **外部 LLM 整合**：串接專業 AI 稽核服務評估 GPT 回答品質
- **批次評估系統**：支援並行處理多筆問答,大幅提升評估效率
- **智能問答配對**：自動配對用戶問題與對應的 GPT 回答
- **四級解決狀態**：是（完全解決）/ 部分（部分解決）/ 否（未解決）/ 未知（無法判斷）
- **精確正確率**：0-100% 數值化評估回答準確度
- **並發控制**：智能管理 API 請求,避免服務過載

### 💾 數據匯出
- **完整 CSV 匯出**：包含 KPI 摘要、每日統計、時段分析、詳細 log 四大表格
- **PM 專用範本**：針對項目管理需求的專門匯出格式（目前提供函式 `exportPmTemplateCSV`，尚未在 UI 露出）
- **自訂日期範圍**：支援指定時間範圍的數據分析

### 🎨 使用者介面
- **浮動面板設計**：右下角可拖拽移動的統計面板
- **多表格切換**：四種不同視圖的智能切換
- **響應式設計**：適配各種螢幕尺寸與解析度
- **現代化 UI**：採用漸層色彩與動畫效果

> 💡 PM 專用範本目前未在面板按鈕露出。如需使用，可於 Console 呼叫 `exportPmTemplateCSV()`（後續版本將加入按鈕）。


## �️ 安裝與使用

### 安裝步驟
1. 打開瀏覽器擴充功能管理頁面：
  ```bash
  chrome://extensions
  edge://extensions
  ```
2. 開啟右上角的「開發人員模式」開關
3. 點擊「載入未封裝項目」按鈕
4. 選擇本專案的 `extension` 資料夾
5. 安裝完成後，擴充功能會出現在已安裝清單中

### 使用方法
1. **進入目標頁面**：開啟 MIS Bot 查詢頁面
  - URL 格式：
    ```
    https://misbot-beta.mitac.com.tw/pms/platformAnalysis/UserChat*
    ```
2. **面板自動顯示**：右下角會自動出現統計面板
3. **操作按鈕說明**：
  - 🔵 **KPI摘要**：顯示週間關鍵績效指標
  - 🔵 **每日統計**：顯示每日唯一使用人次表格
  - 🔵 **時段分析**：顯示 24 小時使用分佈圖表
  - 🔵 **詳細log**：顯示完整的使用記錄（含 AI 評估）
  - 🟡 **聚合全頁**：跨所有頁面聚合數據
  - 🟡 **匯出CSV**：下載完整統計報告
  - 🔴 **✕**：關閉統計面板

### 面板操作
- **拖拽移動**：點擊面板標題區域可拖拽移動面板位置
- **表格切換**：點擊任一表格按鈕切換不同視圖
- **自動儲存**：面板位置與設定會自動保存


## 📊 KPI 摘要功能

點擊「KPI摘要」按鈕可查看完整的週間關鍵績效指標，所有數據基於 AI 智能分析：

### 核心指標表格

| **指標類別** | **指標名稱** | **說明** | **計算邏輯** |
|--------------|--------------|----------|--------------|
| 📅 **時間範圍** | 週起/週終 | 當前統計週的起始與結束日期 | 週一至週五（工作日） |
| 👥 **使用者活躍度** | 日活平均 DAU (avg) | 本週平均每日活躍用戶數 | 週間每日唯一用戶數平均值 |
| 👥 **使用者活躍度** | 週活 WAU | 本週活躍用戶總數 | 週間所有唯一用戶數（去重） |
| 📈 **查詢量分析** | 本週查詢總數 | 本週所有用戶查詢次數統計 | User + GPT 記錄總和 |
| 📈 **查詢量分析（修正）** | 本週查詢總數 | 以使用者提問（問答對）數量統計 | 每筆 User 提問配對為 1 筆（不累加 GPT 行數） |
| ⏰ **時段分析** | 高峰時段 | 查詢量最高的小時時段 | 24小時中查詢數最多的時段 |
| ⏰ **時段分析** | 高峰時段查詢數 | 高峰時段的具體查詢數量 | 該時段的查詢總數 |
| 📊 **使用深度** | 每用戶平均查詢 | 平均每位用戶的查詢次數 | **總查詢數 ÷ 唯一用戶數** |
| 🎯 **品質指標** | 解決率* | AI 評估的問題解決比例 (加權) | **(完全解決 + 0.5×部分解決) ÷ 已評估問答對數** |
| 📈 **品質指標（修正）** | 平均回答正確率 | AI 評估的回答準確度 | 以「總查詢數」為分母（未取得數值評估者不計入分子） |
| 🔄 **效率指標** | 平均解決嘗試次數 | 解決問題的平均對話輪次 | 解決問題所需的平均嘗試次數 |
| ⚠️ **待改進指標** | 未解決數量 | 未能解決的查詢數量 | AI 評估為「否」的問題數 |
| 🆕 **用戶成長** | 本週新用戶 | 首次使用平台的新用戶 | 本週首次出現的用戶 ID |
| 🔄 **用戶留存** | 本週回訪用戶 | 之前使用過的回訪用戶 | 非首次使用的用戶數量 |

> *加權解決率說明：為避免「部分解決」高估真實問題處理能力，系統以 0.5 權重計入，並且僅計入成功完成 LLM 評估之問答對。


### AI 驅動的品質分析
- 🧠 **智能評估**：每個問答對都經過專業 LLM 評估
- 📊 **量化指標**：解決率與正確率提供客觀的服務品質衡量
- 🎯 **改進方向**：未解決問題數量指出需要改進的領域
- 📈 **趨勢追蹤**：支援週間與自訂時間範圍的 KPI 比較


## 📋 四大核心表格功能

### 🔵 KPI摘要表格
- **用途**：提供週間關鍵績效指標的總覽
- **內容**：13項核心 KPI 指標，含時間範圍、使用者活躍度、品質評估等
- **特色**：基於 AI 評估的量化品質分析
- **適用對象**：管理層、專案經理、品質稽核人員

### 🔵 每日統計表格
- **用途**：展示每日唯一使用者數量變化趨勢
- **內容**：日期、唯一使用者數、查詢總數、解決問題數等
- **特色**：支援跨日期比較，識別使用趨勢
- **適用對象**：營運分析師、產品經理

### 🔵 時段分析表格
- **用途**：分析 24 小時使用者活躍度分佈
- **內容**：每小時查詢數量、用戶分佈、高峰時段識別
- **特色**：熱力圖式呈現，直觀顯示使用習慣
- **適用對象**：系統管理員、客服排班規劃

### 🔵 詳細log表格
- **用途**：提供完整的使用記錄與 AI 評估結果
- **內容**：使用者ID、時間戳記、問題內容、GPT回答、AI評估結果
- **特色**：
  - 🧠 即時 LLM 品質評估
  - 🎯 解決狀態標示（是/否/部分/未知）
  - 📊 正確率百分比顯示
  - 🔗 智能問答配對
- **適用對象**：品質稽核、客服訓練、問題分析

### 表格切換與操作
- **單一顯示**：一次僅顯示一個表格，保持介面簡潔
- **按鈕切換**：點擊對應按鈕即可切換表格檢視
- **狀態記憶**：系統會記住上次選擇的表格類型
- **響應式設計**：所有表格都支援不同螢幕尺寸自適應


## 🧠 AI 智能分析系統


### 外部 LLM 評估引擎
系統整合專業的客服品質稽核 AI，透過外部 ngrok 服務提供精確的 GPT 回答品質評估：


#### 🎯 評估架構
- **API 端點**：
  ```
  https://blowfish-absolute-absolutely.ngrok-free.app/api/generate
  ```
- **評估模型**：`gpt-oss:20b` （可自訂）
- **處理方式**：背景 Service Worker 避免 CORS 限制
- **快取機制**：相同問答組合避免重複評估


#### 📊 解決狀態評估標準
- **是**：用戶問題完全得到解答，提供明確可行的解決方案
- **部分**：回答涉及問題核心但不完整，或僅解決部分子問題
- **否**：完全未回應問題要點，或回答與問題無關
- **未知**：問題過於模糊或回答無法判斷是否解決問題


#### 📈 回答正確率評估（0-100%）
- **90-100%**：資訊完全正確，無誤導內容
- **70-89%**：大部分正確，有輕微不準確
- **50-69%**：部分正確但存在明顯錯誤
- **30-49%**：錯誤較多但有部分有用資訊
- **0-29%**：大部分或完全錯誤


### 🔗 智能問答配對機制
系統採用多重策略自動配對用戶問題與 GPT 回答：


#### 配對策略優先順序（目前實作）
1. **ChatID 精確配對**：相同 chatId 的 User 和 Gpt 記錄自動配對
2. **時間窗口配對**：在無 chatId 時，找出同一使用者 1 分鐘內最近的 GPT 回答
3. **用戶ID限制**：配對時需為同一 userId
4. **時間順序處理**：以時間先後避免跨輪誤配


#### ⚡ 即時評估與快取優化


#### 非同步處理機制
- **背景評估**：LLM 評估在背景進行,不影響主要統計功能
- **批次處理**：支援一次評估多筆問答,提升處理效率
- **並發控制**：最多 4 個並行請求,避免 API 過載
- **漸進式載入**：評估結果即時更新至詳細 log 表格
- **錯誤容錯**：評估失敗時自動回退至預設值（未知/0%）
- **使用者友好**：評估過程對使用者完全透明


#### 智能快取系統
- **問答雜湊**：基於問題與回答內容產生唯一快取鍵值
- **TTL 機制**：快取 10 分鐘後自動過期,確保資料新鮮度
- **重複請求防護**：正在處理的請求不會重複發送
- **跨標籤共享**：Service Worker 層級快取,同一瀏覽器實例共享
- **效能優化**：大幅減少 API 呼叫次數,提升響應速度
- **一致性保證**：相同問答組合結果一致


#### 🔄 重試與容錯機制
- **自動重試**：針對暫時性錯誤(429, 5xx)自動重試最多 2 次
- **指數退避**：重試間隔採用指數退避策略(300ms - 2000ms)
- **超時保護**：單次請求 20 秒超時自動中斷
- **降級策略**：API 不可用時以預設值顯示,不影響主要功能


### 🔧 技術架構特色


#### Manifest V3 相容
- **Service Worker**：採用最新的背景服務架構
- **權限最小化**：僅申請必要的網域與儲存權限
- **安全性強化**：所有外部 API 呼叫經過安全驗證
- **效能優化**：減少記憶體使用與 CPU 負載


#### 跨域請求處理
- **CORS 解決方案**：透過 background.js 統一處理外部 API
- **並發限制**：信號量模式控制同時請求數(MAX_CONCURRENCY=4)
- **請求池管理**：排隊機制確保請求有序處理
- **錯誤處理**：擷取錯誤並回傳預設值,支援自動重試與指數退避
- **降級策略**：API 不可用時以預設值顯示,並保留後續重試的可能


### 🚀 效能特性


#### 批次處理能力
- **並行評估**：支援 1-4 個並發 worker 同時處理
- **進度回報**：即時回報處理進度(函式已實作,UI 未開啟)
- **動態負載平衡**：根據任務數量自動調整並發數
- **錯誤隔離**：單一評估失敗不影響其他項目


#### 效能指標
- 📊 **單次評估**：平均 2-5 秒(視 LLM 回應速度)
- 🚀 **批次吞吐量**：約 4 請求/秒(受並發限制)
- 💾 **快取命中率**：預期 >80%(相同問答組合)
- ⏱️ **超時保護**：20 秒自動中斷,避免長時間等待
- 🔄 **重試成功率**：暫時性錯誤約 90% 可自動恢復


## � 統計規則與資料來源


### 資料擷取規則
- **主要資料源**：錨點元素 `a.textChat-icon.icon` 的 `data-*` 屬性
  - `data-userid`：使用者 ID
  - `data-gptid`：GPT 服務 ID  
  - `data-time`：時間戳記（UTC 格式）
- **時區處理**：自動轉換 UTC 時間為 GMT+8 本地時間
- **時間格式**：預設解析 `YYYY-MM-DD HH:mm:ss`（若來源帶有 `Z` 字尾可能無法解析，需調整來源或擴充解析器）
- **日期分組**：以 `YYYY-MM-DD` 格式作為分組鍵值
- **去重機制**：每日使用 Set 資料結構對 userId 去重

### 統計週期設定
- **預設範圍**：當前週（週一至週五）
- **自訂範圍**：支援指定起始與結束日期
- **範圍儲存**：自訂範圍會保存至瀏覽器本地儲存
- **智能週計算**：自動偵測週一作為週起始日

### 排除清單機制
系統自動排除以下測試與相關帳號，確保統計準確性：
- **實習生帳號**：yalkyao, chenxi, yingzhiw, yutachen, yziang
- **PM 成員**：yuyuanwang, dorislin920, emmalai  
- **高度相關人員**：oscarchiu, richen, allenchen0411, yangjo, nancyw, iiskkchi, jackch

## ⚠️ 注意事項與限制

### 資料準確性
- **頁面結構依賴**：若目標網站更改 HTML 結構或 `data-*` 導致擷取失敗需同步調整 parser
- **備用擷取方案**：當 `data-*` 不可用時，會嘗試從表格欄位推測，但準確性較低
- **時區假設**：系統假設伺服器時間為 UTC，客戶端為 GMT+8

### AI 評估限制
- **網路依賴**：LLM 評估需要穩定的網路連線至外部服務
- **評估主觀性**：AI 評估結果僅供參考，可能與實際用戶滿意度有差異
- **配對準確性**：問答配對基於時間與 ID 匹配，對話記錄不完整可能影響準確性
- **API 可用性**：外部 LLM 服務不可用時會回退至預設評估值

### KPI 計算細節與限制
- **解決率**：以（完全解決 + 0.5 × 部分解決）/ 已評估問答對數 計算
- **平均正確率**：以「已評估問答對數」為分母；未產生數值評估（如尚在審核中）者不會貢獻分子，可能導致平均值保守
- **未回應情境**：無對應 GPT 回答者視為未解決並計入未解決統計

### 已知行為
- **相同聊天中的多輪**：同一 chatId 下，最近的 GPT 回答可能被多個相近時間的 User 提問配對到（目前未做唯一配對耗盡策略）
- **批次評估 API**：背景程式提供批次呼叫與進度回報，但目前 UI 端以逐筆評估為主，未啟用批次發送

### 效能考量
- **記憶體使用**：大量資料聚合時可能占用較多瀏覽器記憶體
- **API 呼叫頻率**：LLM 評估會產生外部 API 請求，請注意服務用量限制
- **快取策略**：雖有快取機制，但首次載入大量資料仍需時間處理


## 🏗️ 系統架構與資料流程


### 模組構成（邏輯視圖）
```
┌──────────────────────┐      ┌──────────────────────┐      ┌──────────────────────┐
│   Browser Tab (DOM)  │      │  Background Service  │      │   External LLM API   │
│  (UserChat Page)     │      │    Worker (MV3)      │      │   (ngrok tunnel)     │
└─────────┬────────────┘      └─────────┬────────────┘      └─────────┬────────────┘
          │ 1. DOM 擷取                 │                              │
          │ (a.textChat-icon.icon)      │                              │
          ▼                             │                              │
┌──────────────────────┐                │                              │
│   content.js         │ 2. Message────▶│                              │
│  - DOM Parser        │   (llmAssess)  │                              │
│  - Data Aggregator   │                ▼                              │
│  - QA Pair Builder   │         ┌──────────────┐                      │
│  - UI Renderer       │         │ Semaphore    │                      │
│  - Cache Manager     │         │ (Max=4)      │                      │
└─────────┬────────────┘         └──────┬───────┘                      │
          │                             │ 3. Acquire                   │
          │                             ▼                              │
          │                      ┌──────────────┐                      │
          │                      │ safeFetchJSON│ 4. POST JSON ───────▶│
          │                      │ - Timeout    │                      │
          │                      │ - Retry      │◀─── 5. Response ─────┤
          │                      │ - Backoff    │                      │
          │                      └──────┬───────┘                      │
          │                             │ 6. Parse & Validate          │
          │                             ▼                              │
          │                      ┌──────────────┐                      │
          │◀─── 7. sendResponse ─│ Result Cache │                      │
          │                      │ (TTL: 10min) │                      │
          ▼                      └──────────────┘                      │
  Data Structures:                                                     │
  - dailyUserSetMap                                                    │
  - hourlyBuckets                                                      │
  - qaPairs (with LLM results)                                         │
  - kpiSnapshot                                                        │
```

### 並發控制機制

#### 信號量模式 (Semaphore Pattern)
```javascript
MAX_CONCURRENCY = 4
inFlight = 0
queue = []

acquire() → Promise<release()>
  if (inFlight < MAX) {
    inFlight++
    return release() → { inFlight--; processQueue() }
  } else {
    queue.push(tryAcquire)
    await until slot available
  }
```

#### 快取分層
```
┌─────────────────────────────────┐
│ L1: inflightCache (防重複發送)   │  生命週期: 請求進行中
├─────────────────────────────────┤
│ L2: resultCache (TTL=10min)     │  生命週期: Service Worker
└─────────────────────────────────┘
  Key = hash(model + question + answer)
```


### 資料生命週期步驟

#### 階段一：資料擷取與聚合
1. **DOM 掃描**：擷取符合 selector 的錨點或行記錄
2. **標準化**：時間轉換 (UTC→GMT+8)、ID 過濾、排除清單應用
3. **分類聚合**：依日期 (YYYY-MM-DD)、小時、userId 分組
4. **問答配對**：依 chatId 或時間窗口配對形成 QA Pair

#### 階段二：LLM 評估流程
5. **評估排程**：將未評估 pair 加入評估佇列
6. **快取檢查**：
   - L1: inflightCache - 檢查是否正在評估
   - L2: resultCache - 檢查 10 分鐘內快取
7. **並發控制**：
   - 取得信號量 (最多 4 個並發)
   - 若已滿則加入等待佇列
8. **API 呼叫**：
   - 建立 AbortController (20 秒超時)
   - POST JSON 至 ngrok LLM 端點
   - 解析回應並驗證格式
9. **錯誤處理**：
   - 429/5xx → 自動重試 (最多 2 次)
   - 超時/網路錯誤 → 指數退避重試
   - 失敗 → 回傳預設值 (未知/0%)
10. **結果快取**：儲存至 resultCache (TTL=10min)

#### 階段三：統計與呈現
11. **回傳結果**：透過 chrome.runtime.sendMessage 回傳至 content script
12. **KPI 重算**：新評估結果進來時做增量更新
13. **UI 更新**：即時更新詳細 log 表格
14. **資料匯出**：序列化目前記憶體統計為多 CSV


### 關鍵資料結構摘要
| **名稱** | **類型** | **作用** |
|----------|----------|----------|
| dailyUserSetMap | Map<date, Set<userId>> | 計算每日唯一使用者 |
| hourlyBuckets | Array[24] of {count, users:Set} | 時段分佈與峰值 |
| qaPairs | Map<pairKey, {question, answer, status, accuracy,...}> | AI 評估與結果快取 |
| kpiSnapshot | Object | 最新 KPI 指標快取 |


## 📐 KPI 精確計算公式

> 現況 vs 目標：本節同時標示「目前實作」與「規劃/文件目標」。若顯示 (尚未實作) 表示仍待程式調整；請參考 [Roadmap](#-roadmap)。

| **指標** | **目前實作公式** | **文件/目標公式** | **備註** |
|----------|-------------------|-------------------|----------|
| WAU | unique(週內 userId) | 同 | 去重後使用者數 |
| 平均 DAU | Σ dailyUnique / 有資料的日數 | Σ dailyUnique / 工作日數 | 目前包含自訂範圍內任何有資料的日；未必只限週一~週五 |
| 總查詢數 raw | (尚未實作計算) | User+GPT 行數 | 未納入 KPI；仍在規劃收集 GPT 行數分開統計 |
| 總查詢數 user | user 問題筆數 (全部含未回/未審核) | 同 | 也是後續「評估分母」暫代用值 |
| 評估問答對數 | user 問題筆數 (未區分是否完成 LLM 評估) | Count(完成配對且送評估) | 目前尚未排除「審核中 / 無 GPT 回答」案例 (提升精確度待實作) |
| 解決率 | Full / user 問題筆數 | **(Full + 0.5×Partial)/evaluatedPairs** | 加權邏輯尚未實作；Partial 目前計 0；屬保守估計 |
| 加權解決率 (目標) | — | **(Full + 0.5×Partial)/evaluatedPairs** | 計畫實作後替換「解決率」欄位顯示 |
| 平均正確率 | Σ accuracy / user 問題筆數 | Σ accuracy / evaluatedPairs | 分母包含未取得分數者 → 數值偏保守；將來改為只含已完成評估 |
| 未解決數 (現用) | user 問題筆數 - Full | Count(status==否) | 目前將 部分/未知/無回答 全部歸為未解決；後續可能拆成 strict/extended |
| 未解決數 (strict 目標) | — | Count(status==否) | 規劃新增欄位或在 CSV 顯示 |
| 平均嘗試次數 | user 問題筆數 / Full | Σ(解決問題輪次)/解決問題數 | 目前未做 thread 聚合；視多輪同題為多筆獨立問題 |
| 每用戶平均查詢 | user 問題筆數 / WAU | 同 | — |
| 峰值時段 | argmax(hourly.count) | 同 | 回傳對應 count |


### 待改進重點 ([Roadmap](#-roadmap) 摘要)
1. 拆分 `evaluatedPairs` 與「全部 user 問題」分母
2. 實作加權解決率 (Partial 0.5)
3. 分離未解決 strict (僅否) 與 extended (否+部分+未知+無回答)
4. 增補 raw (User+GPT) 雙計數以供對照
5. Thread 聚合推估多輪嘗試次數


### 參考
- 內部治理與安全邊界：[INTERNAL_USE.md](./INTERNAL_USE.md)
- CSV 對應 JSON Schemas：`/schemas/*.schema.json`
- 若將來指標邏輯實作與此表不符，請更新本節與 [CHANGELOG](./CHANGELOG)。


> 註：未成功配對或尚未評估之問答不計入 evaluatedPairs；解決率與正確率不受多餘 GPT 行數影響。


## 📄 CSV 匯出格式說明

> **CSV 檔案僅供內部分析，不得外流或提供第三方。**
```csv
# Internal Use Only - 此 CSV 僅供內部分析，不得外流或提供第三方。
# 若需對外呈現，請先去識別並通過主管與資安審核。
```

目前匯出為多檔（或後續可能打包）邏輯表：

### 1. KPI Summary `kpi_summary.csv`
| **欄位** | **說明** |
|----------|----------|
| week_start | 週期起始 (YYYY-MM-DD) |
| week_end | 週期結束 |
| dau_avg | 平均日活 |
| wau | 週活 |
| total_queries_raw | 原始 (User+GPT) 行數 |
| total_queries_user | 使用者提問數 |
| peak_hour | 峰值小時 (0-23) |
| peak_hour_volume | 峰值查詢數 |
| avg_query_per_user | 每用戶平均查詢 |
| resolution_rate_weighted | 加權解決率 (尚未實作，暫以現行 Full/user 問題替代視圖呈現) |
| avg_accuracy | 平均正確率 (現行分母含未完成評估，為保守值) |
| avg_attempts_to_solve | 平均解決嘗試輪次 |
| unresolved_count | 未解決問答對數 |
| new_users | 新用戶數 |
| returning_users | 回訪用戶數 |
| generated_at | 產出時間 (ISO) |

### 2. Daily Stats `daily_stats.csv`
| **date** | **unique_users** | **user_queries** | **total_queries_raw** | **solved_full** | **solved_partial** | **resolution_rate_weighted** | **avg_accuracy** | **unresolved** |

### 3. Hourly Distribution `hourly_distribution.csv`
| **hour** | **query_count** | **unique_users** | **percent_of_day** |

### 4. Detail Log `detail_log.csv`
| **index** | **date_time_local** | **user_id** | **chat_id** | **role** | **question** | **answer** | **resolved_status** | **accuracy_score** | **pair_key** | **eval_source** | **eval_latency_ms** | **error_flag** |

### 5. PM Template `pm_template.csv`
尚未於 UI 露出；呼叫 `exportPmTemplateCSV()` 取得。

> 若版本缺少部分欄位，表示功能仍在 [Roadmap](#-roadmap)；請參考後續章節。


## 🔐 權限與安全性說明

### 擴充功能權限
- **content_scripts**：注入目標網站頁面進行資料分析
- **storage**：儲存使用者設定與面板位置  
- **host_permissions**：
  - `https://misbot-beta.mitac.com.tw/*`：存取目標統計網站
  - `https://blowfish-absolute-absolutely.ngrok-free.app/*`：外部 LLM 評估服務
  - `http://localhost/*`, `http://127.0.0.1/*`：本地開發測試

### 資料隱私
- **本地處理**：所有統計計算均在使用者瀏覽器本地進行
- **無資料回傳**：不會將使用者資料傳送至第三方（除 LLM 評估服務外）
- **最小化原則**：僅收集統計必要的匿名化資料
- **透明化**：所有資料處理邏輯開放原始碼檢視

### 最小權限策略與建議
未使用 cookies、tabs、scripting 等高敏感權限；後續若新增需在 CHANGELOG 明確揭露並進行安全審核。

### 外部服務風險緩解建議
1. 增加請求逾時 + 指數退避重試
2. 對回傳 JSON 做 Schema 驗證
3. 錯誤分類：網路 / 限流 / 內容格式
4. 考慮壓縮批次請求降低頻寬


## 🛠️ 開發與偵錯指南

### 快速開始
1. 以「載入未封裝項目」方式安裝 `extension/` 目錄
2. 開啟目標頁面觀察右下角面板是否出現
3. 修改 `content.js` 後於擴充功能頁重新載入，再重新整理目標頁面

### Service Worker 偵錯
Chrome: `chrome://extensions` → 尋找擴充 → 點「Service Worker」Inspect
觀察：
- LLM 請求發送與回傳
- 是否出現 fetch/CORS 錯誤

### Message 流程
1. content.js 建立評估任務 → `runtime.sendMessage`
2. background.js 呼叫外部 API
3. background.js 回傳結果 payload
4. content.js 更新 pair 狀態並觸發表格重新渲染

### 常見開發陷阱
| 問題 | 原因 | 解法 |
|------|------|------|
| 評估結果不更新 | 未註冊 onMessage | 確認 listener 在 top-level |
| fetch 被攔截 | 網域未列於 host_permissions | 更新 manifest.json |
| 面板拖曳失效 | 事件被子元素攔截 | 加 `user-select: none` 並阻止預設 |

### 建議未來模組化（示意）
```
content/
  parser.js
  aggregator.js
  qaMatching.js
  uiPanel.js
  exporter.js
background/
  evaluator.js
```


## ❓ 常見問題與故障排除

### 安裝相關問題

**Q: 擴充功能安裝後沒有出現統計面板？**
- ✅ 確認已開啟目標網站：`https://misbot-beta.mitac.com.tw/pms/platformAnalysis/UserChat*`
- ✅ 檢查瀏覽器是否已啟用開發人員模式
- ✅ 嘗試重新整理頁面或重新載入擴充功能
- ✅ 查看瀏覽器控制台是否有錯誤訊息

**Q: 面板顯示但功能無法正常運作？**
- ✅ 檢查網路連線是否正常
- ✅ 確認目標網站的頁面結構未發生變更
- ✅ 嘗試清除瀏覽器快取後重新載入

### 資料分析問題

**Q: 統計數據似乎不正確？**
- ✅ 確認頁面已完全載入所有聊天記錄
- ✅ 使用「聚合全頁」功能獲取完整資料
- ✅ 檢查日期範圍設定是否正確
- ✅ 注意排除清單可能影響最終統計結果

**Q: AI 評估結果一直顯示「未知/0%」？**
- ✅ 檢查網路連線至外部 LLM 服務
- ✅ 確認 ngrok 服務端點是否可正常存取
- ✅ 等待背景評估完成（可能需要數分鐘）
- ✅ 查看瀏覽器網路標籤是否有 API 錯誤

### 效能相關問題

**Q: 聚合大量資料時瀏覽器變慢？**
- ✅ 建議分批處理大量資料
- ✅ 關閉其他不必要的瀏覽器分頁
- ✅ 考慮使用較小的日期範圍
- ✅ 等待處理完成後再進行其他操作

**Q: CSV 匯出失敗或檔案損壞？**
- ✅ 確保瀏覽器允許檔案下載
- ✅ 檢查磁碟空間是否充足
- ✅ 嘗試使用較小的資料集進行匯出
- ✅ 使用不同的檔案名稱重新匯出

### 使用技巧

**Q: 如何獲得最準確的統計結果？**
- 💡 使用「聚合全頁」獲取完整資料
- 💡 設定適當的日期範圍避免資料過於龐大
- 💡 等待 AI 評估完成後再匯出報告
- 💡 定期備份重要統計資料

**Q: 如何解讀 AI 評估結果？**
- 💡 「是」表示問題完全解決，「部分」表示部分解決
- 💡 正確率 90% 以上為優秀，70% 以上為良好
- 💡 注意未解決問題的模式，找出改進方向
- 💡 結合實際使用者回饋驗證評估結果


## 🗺️ Roadmap

| **狀態** | **項目** | **說明** | **預計版本** |
|----------|----------|----------|--------------|
| ✅ 完成 | 批次評估 API | 並發控制、重試機制、快取優化 | v0.3.0 |
| ✅ 完成 | 自動重試機制 | 指數退避、超時保護 | v0.3.0 |
| ✅ 完成 | TTL 快取系統 | 10 分鐘過期、跨標籤共享 | v0.3.0 |
| 進行中 | 批次評估 UI | 將背景批次佇列進度條可視化 | v0.4.0 |
| 進行中 | API 身份驗證 | ngrok 端點加入 API Key 保護 | v0.4.0 |
| 計畫中 | PM 匯出按鈕 | 將 `exportPmTemplateCSV` 露出於 UI | v0.4.0 |
| 計畫中 | 雙語介面 | zh-TW / en-US 切換 | v0.5.0 |
| 計畫中 | 問答配對策略 v2 | 限制一對一避免多重配對 | v0.5.0 |
| 計畫中 | IndexedDB 持久快取 | 跨重新整理保留評估結果 | v0.5.0 |
| 計畫中 | Schema 驗證 | 對 LLM 回傳格式進行 JSON schema 驗證 | v0.5.0 |
| 評估中 | 模糊語意去重 | 合併重複提問統計 | - |
| 評估中 | 指標趨勢比較 | 週對週 / 範圍對範圍差異 | - |
| 評估中 | 自動異常提醒 | 解決率、正確率低於閾值告警 | - |


## ❓ FAQ（進階）
**Q: 為什麼加權解決率與初版說明不同?**  
A: 初版未加權會高估「部分解決」,採 0.5 權重更符合服務實際價值。

**Q: accuracy_score 缺失時如何處理?**  
A: 不納入平均計算（避免拉低或抬高）,仍計入評估基數保守呈現。

**Q: 可以關閉 LLM 評估嗎?**  
A: 目前無 UI；可在 background.js 中短路評估函式快速停用。

**Q: 同一問題多次提問是否合併?**  
A: 目前視為獨立；未來可能加入語意哈希做去重。

**Q: 是否支援離線後自動重送?**  
A: 尚未；計畫透過離線佇列 + IndexedDB 實作。

**Q: 匯出欄位能客製嗎?**  
A: 尚未；Roadmap 項目「自訂匯出欄位」。

**Q: 批次評估比單次評估快多少?**  
A: 理論上可提升 3-4 倍效率(並發數=4),實際視 API 回應時間而定。

**Q: 為什麼設定 20 秒超時?**  
A: 平衡使用者體驗與 LLM 回應時間,過短會導致正常請求被中斷,過長會影響互動體驗。

**Q: 快取 10 分鐘是否過長?**  
A: 對於相同問答組合,評估結果應該一致,10 分鐘內重複評估沒有意義且浪費 API 配額。

**Q: 並發數為什麼是 4?**  
A: 平衡吞吐量與 API 伺服器負載,避免觸發速率限制;可在 background.js 調整 MAX_CONCURRENCY。


## 📝 版本資訊
**版本**：v0.3.0  
**最後更新**：2025-10-31  
**相容性**：Chrome 88+, Edge 88+（Manifest V3）  
**授權**：內部使用

### 版本歷程
- **v0.3.0** (2025-10-31): 批次評估系統、並發控制、自動重試、TTL 快取
- **v0.2.0** (2025-09-12): 文件與指標公式強化、安全性改進
- **v0.1.0** (2025-09-09): 外部 LLM 評估系統整合
- **v0.0.1** (2025-08-28): 核心功能建立


---

> 若發現文件與實際行為不一致，提交 Issue / 內部單時請附：瀏覽器版本、截圖、Console 與 Network 日誌片段以加速定位。
